<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenStream PRO | Mobile Ready</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0f; --surface: #16161e; --text: #eee; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: var(--text); overflow: hidden; }

        /* –õ–û–ë–ë–ò */
        #lobby { display: flex; flex-direction: column; align-items: center; padding: 20px; height: 100vh; overflow-y: auto; box-sizing: border-box; }
        .setup-card { background: var(--surface); padding: 25px; border-radius: 20px; border: 1px solid #333; width: 100%; max-width: 400px; text-align: center; margin-bottom: 30px; }
        
        /* –°–ü–ò–°–û–ö –°–¢–†–ò–ú–û–í */
        .streams-list { width: 100%; max-width: 500px; }
        .stream-item { background: #1c1c27; border: 1px solid #333; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ö–û–ú–ù–ê–¢–´ */
        #room { display: none; height: 100vh; flex-direction: column; }
        header { height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #222; }
        
        .video-container { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }

        /* –ß–ê–¢ –í–ù–ò–ó–£ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) */
        .chat-area { height: 30%; background: var(--surface); border-top: 1px solid #222; display: flex; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .chat-input { padding: 10px; background: #000; display: flex; gap: 8px; }

        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #050505; color: white; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        button { padding: 10px 18px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-green { background: var(--accent); color: #000; }
        .btn-red { background: #ff4757; color: white; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="setup-card">
        <h2>–°–æ–∑–¥–∞—Ç—å —ç—Ñ–∏—Ä</h2>
        <input type="text" id="user-nick" placeholder="–¢–≤–æ–µ –∏–º—è">
        <input type="text" id="room-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∏–º–∞">
        <button class="btn-green" style="width: 100%" onclick="startHosting()">–í–´–ô–¢–ò –í –≠–§–ò–†</button>
    </div>

    <div class="streams-list">
        <h3 style="text-align: center;">üî¥ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏</h3>
        <div id="room-list-box"></div>
    </div>
</div>

<div id="room">
    <header>
        <div id="display-title" style="font-weight: bold; font-size: 14px;">–≠—Ñ–∏—Ä</div>
        <button class="btn-red" onclick="terminate()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </header>

    <div class="video-container">
        <video id="player" autoplay playsinline webkit-playsinline muted></video>
    </div>

    <div class="chat-area">
        <div id="chat-msgs"></div>
        <div class="chat-input">
            <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button class="btn-green" onclick="broadcastMsg()">></button>
        </div>
    </div>
</div>

<script>
    const DB_PATH = "https://cassa-simulator-4-default-rtdb.firebaseio.com/live_v4";
    const peer = new Peer();
    let myId = "";
    let myStream = null;
    let activeId = "";

    peer.on('open', id => { myId = id; refreshRooms(); });

    // 1. –ó–ê–ü–£–°–ö –≠–§–ò–†–ê (–•–û–°–¢)
    async function startHosting() {
        const nick = document.getElementById('user-nick').value;
        const title = document.getElementById('room-title').value;
        if (!nick || !title) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        try {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞)
            myStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user" },
                audio: true
            });

            const player = document.getElementById('player');
            player.srcObject = myStream;
            player.play(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç

            activeId = myId;
            await fetch(`${DB_PATH}/rooms/${myId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ title, host: nick, id: myId })
            });

            peer.on('call', call => call.answer(myStream));
            
            toggleUI(title);
            startChatLoop(myId, nick);
        } catch (e) {
            alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å HTTPS –∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.");
        }
    }

    // 2. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï (–ó–†–ò–¢–ï–õ–¨)
    function joinLive(hostId, title) {
        const nick = document.getElementById('user-nick').value || "–ó—Ä–∏—Ç–µ–ª—å";
        activeId = hostId;
        toggleUI(title);

        const call = peer.call(hostId, null);
        call.on('stream', remoteStream => {
            const player = document.getElementById('player');
            player.srcObject = remoteStream;
            player.muted = false; // –ó—Ä–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–ª—ã—à–∞—Ç—å
            player.play().catch(() => console.log("–ù–∞–∂–º–∏ –Ω–∞ –≤–∏–¥–µ–æ –¥–ª—è –∑–≤—É–∫–∞"));
        });
        startChatLoop(hostId, nick);
    }

    // 3. –ß–ê–¢ –ò –°–ü–ò–°–û–ö
    async function broadcastMsg() {
        const inp = document.getElementById('m-input');
        const nick = document.getElementById('user-nick').value || "–ì–æ—Å—Ç—å";
        if (!inp.value.trim()) return;

        await fetch(`${DB_PATH}/chats/${activeId}.json`, {
            method: 'POST',
            body: JSON.stringify({ u: nick, t: inp.value })
        });
        inp.value = "";
    }

    function startChatLoop(roomId, nick) {
        setInterval(async () => {
            const res = await fetch(`${DB_PATH}/chats/${roomId}.json`);
            const data = await res.json();
            const box = document.getElementById('chat-msgs');
            box.innerHTML = "";
            for (let i in data) {
                box.innerHTML += `<div><b>${data[i].u}:</b> ${data[id=i].t}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }, 2500);
    }

    async function refreshRooms() {
        const res = await fetch(`${DB_PATH}/rooms.json`);
        const data = await res.json();
        const box = document.getElementById('room-list-box');
        box.innerHTML = "";
        if (!data) return box.innerHTML = "<p>–≠—Ñ–∏—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>";

        for (let id in data) {
            const r = data[id];
            box.innerHTML += `
                <div class="stream-item">
                    <div><b>${r.title}</b><br><small>${r.host}</small></div>
                    <button class="btn-green" onclick="joinLive('${r.id}', '${r.title}')">–°–ú–û–¢–†–ï–¢–¨</button>
                </div>`;
        }
    }

    function toggleUI(title) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('room').style.display = 'flex';
        document.getElementById('display-title').innerText = title;
    }

    async function terminate() {
        if (myStream) myStream.getTracks().forEach(t => t.stop());
        if (activeId === myId) await fetch(`${DB_PATH}/rooms/${myId}.json`, { method: 'DELETE' });
        location.reload();
    }

    setInterval(refreshRooms, 5000);
</script>
</body>
</html>
