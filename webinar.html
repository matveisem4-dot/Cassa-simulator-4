<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OpenStream: Self-Broadcast</title>
    <style>
        :root { --accent: #10b981; --bg: #0f172a; --surface: #1e293b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 15px 20px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* Список каналов */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid #334155; padding: 15px; }
        .channel-item { padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; }
        .channel-item:hover { border-color: var(--accent); }

        /* Зона вещания */
        .viewer-zone { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }

        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-stream { background: var(--accent); color: white; }
        .btn-stop { background: #ef4444; color: white; display: none; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 20px; font-weight: bold;">OpenStream <span style="color: var(--accent)">LIVE</span></div>
    <div id="status-info">Зритель</div>
</header>

<div class="main-layout">
    <div class="sidebar">
        <h3>Эфиры</h3>
        <div id="stream-list">
            <div class="channel-item">Пока нет активных трансляций...</div>
        </div>
    </div>

    <div class="viewer-zone">
        <video id="live-video" autoplay playsinline muted></video>
        
        <div class="controls">
            <button id="start-btn" class="btn-stream" onclick="startCapture()">ТРАНСЛИРОВАТЬ ЭКРАН</button>
            <button id="stop-btn" class="btn-stop" onclick="stopCapture()">ОСТАНОВИТЬ</button>
        </div>
    </div>
</div>

<script>
    let localStream = null;
    const videoElement = document.getElementById('live-video');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');

    // Функция захвата экрана
    async function startCapture() {
        try {
            // Запрашиваем доступ к экрану
            localStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: true
            });

            videoElement.srcObject = localStream;
            
            // Интерфейсные изменения
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            document.getElementById('status-info').innerText = "В ЭФИРЕ";
            document.getElementById('status-info').style.color = "#10b981";

            // Когда пользователь нажимает "Прекратить доступ" в системном окне
            localStream.getVideoTracks()[0].onended = () => stopCapture();

            // В реальном проекте здесь бы шел код отправки потока через WebRTC (SimplePeer)
            console.log("Поток захвачен. Готов к передаче.");
            
        } catch (err) {
            console.error("Ошибка захвата: " + err);
            alert("Не удалось захватить экран.");
        }
    }

    function stopCapture() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        document.getElementById('status-info').innerText = "Зритель";
        document.getElementById('status-info').style.color = "white";
    }

    // В будущем здесь будет логика Firebase для обмена Peer ID
</script>
</body>
</html>
