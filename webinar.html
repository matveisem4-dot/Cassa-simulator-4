<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStream PRO | Live Platform</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0f; --surface: #16161e; --text: #eee; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê / –õ–û–ë–ë–ò */
        #lobby { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; background: radial-gradient(circle at center, #1e1e2e 0%, #0a0a0f 100%); }
        .setup-card { background: var(--surface); padding: 40px; border-radius: 24px; border: 1px solid #333; width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° –¢–†–ê–ù–°–õ–Ø–¶–ò–ò */
        #room { display: none; height: 100vh; grid-template-columns: 1fr 350px; grid-template-rows: 70px 1fr; }
        header { grid-column: 1 / 3; background: #000; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        
        .video-container { position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* –ß–ê–¢ */
        .sidebar { background: var(--surface); border-left: 1px solid #222; display: flex; flex-direction: column; }
        #chat-content { flex: 1; overflow-y: auto; padding: 20px; font-size: 14px; display: flex; flex-direction: column; gap: 12px; }
        .chat-input-zone { padding: 20px; background: #000; display: flex; gap: 10px; }
        .msg { background: #252530; padding: 10px; border-radius: 10px; border-left: 3px solid var(--accent); }

        /* –ö–ù–û–ü–ö–ò –ò –ò–ù–ü–£–¢–´ */
        input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #333; background: #050505; color: white; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }
        button { padding: 12px 24px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-success { background: var(--accent); color: #000; width: 100%; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-send { background: var(--accent); color: #000; padding: 10px 15px; }

        .stat { display: flex; align-items: center; gap: 8px; color: var(--accent); font-weight: bold; }
        #rooms-list { margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap; }
        .room-card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid #333; cursor: pointer; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="setup-card">
        <h1 style="margin-top:0">OpenStream <span style="color: var(--accent)">PRO</span></h1>
        <input type="text" id="user-nick" placeholder="–í–∞—à–µ –∏–º—è...">
        <input type="text" id="room-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...">
        <button class="btn-success" onclick="startStream()">–ó–ê–ü–£–°–¢–ò–¢–¨ –≠–§–ò–†</button>
        <p style="font-size: 12px; color: #666; margin-top: 15px;">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</p>
    </div>

    <div id="rooms-list">
        </div>
</div>

<div id="room">
    <header>
        <div id="active-title" style="font-size: 1.2rem; font-weight: bold;">üî¥ –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä</div>
        <div style="display: flex; align-items: center; gap: 25px;">
            <div class="stat"><span>üë§</span> <span id="view-count">1</span></div>
            <button class="btn-danger" onclick="stopEverything()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </header>

    <div class="video-container">
        <video id="main-player" autoplay playsinline></video>
    </div>

    <div class="sidebar">
        <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #222;">üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò</div>
        <div id="chat-content"></div>
        <div class="chat-input-zone">
            <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button class="btn-send" onclick="sendChatMessage()">></button>
        </div>
    </div>
</div>

<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    const DB_BASE = "https://cassa-simulator-4-default-rtdb.firebaseio.com/pro_v2";
    const peer = new Peer();
    let myId = "";
    let myName = "";
    let myStream = null;
    let currentRoomId = "";

    peer.on('open', id => { 
        myId = id; 
        updateLobby(); 
    });

    // 1. –ó–ê–ü–£–°–ö –°–¢–†–ò–ú–ê (–î–õ–Ø –•–û–°–¢–ê)
    async function startStream() {
        myName = document.getElementById('user-nick').value || "–ê–Ω–æ–Ω–∏–º";
        const title = document.getElementById('room-name').value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        if(!myName || !title) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

        try {
            // –ó–∞—Ö–≤–∞—Ç –º–µ–¥–∏–∞ (–ö–∞–º–µ—Ä–∞ + –ú–∏–∫—Ä–æ—Ñ–æ–Ω)
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('main-player').srcObject = myStream;
            document.getElementById('main-player').muted = true; // –ß—Ç–æ–±—ã —Ö–æ—Å—Ç –Ω–µ —Å–ª—ã—à–∞–ª —Å–∞–º —Å–µ–±—è

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            currentRoomId = myId;
            await fetch(`${DB_BASE}/rooms/${myId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ title, hostId: myId, hostName: myName })
            });

            // –ñ–¥–µ–º –∑–≤–æ–Ω–∫–æ–≤ –æ—Ç –∑—Ä–∏—Ç–µ–ª–µ–π
            peer.on('call', call => {
                call.answer(myStream);
            });

            enterRoom(title);
            startChatListener(myId);
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.");
        }
    }

    // 2. –í–•–û–î –í –ß–£–ñ–û–ô –°–¢–†–ò–ú (–î–õ–Ø –ó–†–ò–¢–ï–õ–Ø)
    async function joinRoom(hostId, title) {
        myName = document.getElementById('user-nick').value || "–ó—Ä–∏—Ç–µ–ª—å";
        currentRoomId = hostId;
        enterRoom(title);

        const call = peer.call(hostId, null);
        call.on('stream', remoteStream => {
            const player = document.getElementById('main-player');
            player.srcObject = remoteStream;
            player.muted = false; // –ó—Ä–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–ª—ã—à–∞—Ç—å –∑–≤—É–∫
        });

        startChatListener(hostId);
    }

    // 3. –ß–ê–¢
    async function sendChatMessage() {
        const inp = document.getElementById('chat-input');
        if(!inp.value.trim()) return;

        await fetch(`${DB_BASE}/chats/${currentRoomId}.json`, {
            method: 'POST',
            body: JSON.stringify({ name: myName, text: inp.value, time: Date.now() })
        });
        inp.value = "";
    }

    function startChatListener(roomId) {
        setInterval(async () => {
            const res = await fetch(`${DB_BASE}/chats/${roomId}.json`);
            const data = await res.json();
            const box = document.getElementById('chat-content');
            box.innerHTML = "";
            for(let id in data) {
                box.innerHTML += `<div class="msg"><b>${data[id].name}:</b> ${data[id].text}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }, 2000);
    }

    // 4. –ó–ê–í–ï–†–®–ï–ù–ò–ï
    async function stopEverything() {
        if(myStream) {
            myStream.getTracks().forEach(t => t.stop());
        }
        if(currentRoomId === myId) {
            await fetch(`${DB_BASE}/rooms/${myId}.json`, { method: 'DELETE' });
            await fetch(`${DB_BASE}/chats/${myId}.json`, { method: 'DELETE' });
        }
        location.reload();
    }

    // 5. –õ–û–ë–ë–ò –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï
    function enterRoom(title) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('room').style.display = 'grid';
        document.getElementById('active-title').innerText = "üî¥ " + title;
    }

    async function updateLobby() {
        const res = await fetch(`${DB_BASE}/rooms.json`);
        const data = await res.json();
        const list = document.getElementById('rooms-list');
        list.innerHTML = "";
        for(let id in data) {
            const room = data[id];
            const div = document.createElement('div');
            div.className = 'room-card';
            div.innerHTML = `<b>${room.title}</b><br><small>–ê–≤—Ç–æ—Ä: ${room.hostName}</small>`;
            div.onclick = () => joinRoom(room.hostId, room.title);
            list.appendChild(div);
        }
    }

    setInterval(updateLobby, 5000);
</script>
</body>
</html>
