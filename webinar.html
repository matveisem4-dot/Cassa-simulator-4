<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OpenStream PRO | Multi-Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0f; --surface: #16161e; --text: #eee; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* ЭКРАН ВХОДА */
        #lobby { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; }
        .setup-card { background: var(--surface); padding: 30px; border-radius: 20px; border: 1px solid #333; width: 100%; max-width: 400px; text-align: center; margin-bottom: 40px; }
        
        /* КАРТОЧКИ СТРИМОВ */
        .streams-container { width: 100%; max-width: 800px; }
        .stream-card { 
            background: #1c1c27; border: 1px solid #333; padding: 20px; border-radius: 15px; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            transition: 0.3s;
        }
        .stream-card:hover { border-color: var(--accent); background: #252535; }

        /* ИНТЕРФЕЙС ЭФИРА */
        #room { display: none; height: 100vh; grid-template-columns: 1fr 350px; }
        .main-video-zone { background: #000; position: relative; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* ЧАТ И БОКОВАЯ ПАНЕЛЬ */
        .sidebar { background: var(--surface); border-left: 1px solid #222; display: flex; flex-direction: column; }
        #chat-content { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; }
        .chat-input-area { padding: 15px; background: #000; display: flex; gap: 5px; }

        /* КНОПКИ */
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #050505; color: white; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-green { background: var(--accent); color: #000; }
        .btn-join { background: var(--accent); color: #000; white-space: nowrap; }
        .btn-red { background: #ff4757; color: white; }

        .live-dot { height: 10px; width: 10px; background-color: red; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="lobby">
    <div class="setup-card">
        <h2>Начать свой стрим</h2>
        <input type="text" id="user-name" placeholder="Ваше имя">
        <input type="text" id="stream-title" placeholder="Название эфира">
        <button class="btn-green" style="width: 100%;" onclick="createStream()">ВЫЙТИ В ПРЯМОЙ ЭФИР</button>
    </div>

    <div class="streams-container">
        <h2 style="text-align: center;"><span class="live-dot"></span> ДОСТУПНЫЕ ЭФИРЫ</h2>
        <div id="room-list">
            <p style="text-align: center; color: #666;">Поиск активных трансляций...</p>
        </div>
    </div>
</div>

<div id="room">
    <div class="main-video-zone">
        <div style="padding: 15px; background: rgba(0,0,0,0.7); display: flex; justify-content: space-between; align-items: center;">
            <b id="current-title">Эфир</b>
            <button class="btn-red" onclick="closeStream()">ЗАВЕРШИТЬ / ВЫЙТИ</button>
        </div>
        <video id="video-player" autoplay playsinline></video>
    </div>

    <div class="sidebar">
        <div style="padding: 15px; border-bottom: 1px solid #222;">ЧАТ</div>
        <div id="chat-content"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-msg" placeholder="Сообщение..." style="margin:0">
            <button class="btn-green" onclick="sendChat()">></button>
        </div>
    </div>
</div>

<script>
    const DB_URL = "https://cassa-simulator-4-default-rtdb.firebaseio.com/openstream_v3";
    const peer = new Peer();
    let myId = "";
    let myStream = null;
    let activeRoomId = "";

    peer.on('open', id => { myId = id; refreshLobby(); });

    // 1. СОЗДАТЬ СТРИМ
    async function createStream() {
        const name = document.getElementById('user-name').value;
        const title = document.getElementById('stream-title').value;
        if (!name || !title) return alert("Введите имя и название!");

        try {
            myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('video-player').srcObject = myStream;
            document.getElementById('video-player').muted = true; // Стример не слышит сам себя

            activeRoomId = myId;
            await fetch(`${DB_URL}/rooms/${myId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ title, hostName: name, hostId: myId })
            });

            peer.on('call', call => call.answer(myStream));
            openRoomUI(title);
            listenChat(myId);
        } catch (e) { alert("Ошибка доступа к камере!"); }
    }

    // 2. ПОДКЛЮЧИТЬСЯ К СТРИМУ
    async function joinStream(hostId, title) {
        activeRoomId = hostId;
        openRoomUI(title);
        
        const call = peer.call(hostId, null);
        call.on('stream', remoteStream => {
            const player = document.getElementById('video-player');
            player.srcObject = remoteStream;
            player.muted = false; // Зритель СЛЫШИТ звук
        });
        listenChat(hostId);
    }

    // 3. ОБНОВЛЕНИЕ СПИСКА (ЛОББИ)
    async function refreshLobby() {
        const res = await fetch(`${DB_URL}/rooms.json`);
        const data = await res.json();
        const container = document.getElementById('room-list');
        container.innerHTML = "";

        if (!data || Object.keys(data).length === 0) {
            container.innerHTML = "<p style='text-align: center; color: #666;'>Стримов пока нет. Стань первым!</p>";
            return;
        }

        for (let id in data) {
            const r = data[id];
            const card = document.createElement('div');
            card.className = 'stream-card';
            card.innerHTML = `
                <div>
                    <div style="font-weight: bold; font-size: 18px;">${r.title}</div>
                    <div style="color: #888; font-size: 14px;">Автор: ${r.hostName}</div>
                </div>
                <button class="btn-join" onclick="joinStream('${r.hostId}', '${r.title}')">ПОДКЛЮЧИТЬСЯ</button>
            `;
            container.appendChild(card);
        }
    }

    // 4. ЧАТ И ЗАВЕРШЕНИЕ
    async function sendChat() {
        const inp = document.getElementById('chat-msg');
        const nick = document.getElementById('user-name').value || "Гость";
        if (!inp.value.trim()) return;

        await fetch(`${DB_BASE}/chats/${activeRoomId}.json`, {
            method: 'POST',
            body: JSON.stringify({ user: nick, text: inp.value })
        });
        inp.value = "";
    }

    function listenChat(roomId) {
        setInterval(async () => {
            const res = await fetch(`${DB_URL}/chats/${roomId}.json`);
            const data = await res.json();
            const box = document.getElementById('chat-content');
            box.innerHTML = "";
            for (let id in data) {
                box.innerHTML += `<div><b>${data[id].user}:</b> ${data[id].text}</div>`;
            }
        }, 2000);
    }

    function openRoomUI(title) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('room').style.display = 'grid';
        document.getElementById('current-title').innerText = title;
    }

    async function closeStream() {
        if (myStream) myStream.getTracks().forEach(t => t.stop());
        if (activeRoomId === myId) {
            await fetch(`${DB_URL}/rooms/${myId}.json`, { method: 'DELETE' });
        }
        location.reload();
    }

    setInterval(refreshLobby, 5000);
</script>
</body>
</html>
