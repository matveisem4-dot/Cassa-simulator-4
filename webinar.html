<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OpenStream Hub</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #0f172a; --surface: #1e293b; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; }
        
        /* –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω */
        #lobby { display: flex; flex-direction: column; align-items: center; padding: 50px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; margin-top: 30px; }
        .card { background: var(--surface); padding: 20px; border-radius: 15px; border: 1px solid #334155; text-align: center; cursor: pointer; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-5px); }
        
        /* –≠–∫—Ä–∞–Ω —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ */
        #room { display: none; height: 100vh; flex-direction: column; }
        video { flex: 1; background: #000; width: 100%; max-height: 80vh; border-bottom: 2px solid var(--accent); }
        .controls { padding: 20px; display: flex; justify-content: center; gap: 20px; background: var(--surface); }

        button { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: #000; }
        .btn-exit { background: #ef4444; color: white; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="lobby">
    <h1>OpenStream Hub</h1>
    <div style="background: var(--surface); padding: 30px; border-radius: 20px; width: 350px; text-align: center;">
        <h3>–ù–∞—á–∞—Ç—å —Å–≤–æ—é —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</h3>
        <input type="text" id="stream-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã..." style="width: 100%; box-sizing: border-box;">
        <button onclick="startHosting()">–ó–ê–ü–£–°–¢–ò–¢–¨ –≠–§–ò–†</button>
    </div>

    <h2 style="margin-top: 50px;">üî¥ –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä —Å–µ–π—á–∞—Å:</h2>
    <div id="room-list" class="grid">
        <p style="color: #64748b;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç...</p>
    </div>
</div>

<div id="room">
    <div style="padding: 15px; background: #000; display: flex; justify-content: space-between;">
        <span id="room-title" style="font-weight: bold; color: var(--accent);">–≠—Ñ–∏—Ä</span>
        <button class="btn-exit" onclick="location.reload()">–í–´–ô–¢–ò</button>
    </div>
    <video id="remote-video" autoplay playsinline></video>
    <div class="controls" id="host-controls" style="display: none;">
        <button onclick="shareScreen()">–ü–û–ö–ê–ó–ê–¢–¨ –≠–ö–†–ê–ù</button>
    </div>
</div>

<script>
    const DB_URL = "https://cassa-simulator-4-default-rtdb.firebaseio.com/rooms.json";
    let peer = new Peer(); // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≤–∏–¥–µ–æ-—Å–≤—è–∑–∏
    let myPeerId = "";

    peer.on('open', (id) => { myPeerId = id; loadRooms(); });

    // 1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã (–°—Ç—Ä–∏–º–µ—Ä)
    async function startHosting() {
        const name = document.getElementById('stream-name').value;
        if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ Firebase
        await fetch(DB_URL.replace('.json', `/${myPeerId}.json`), {
            method: 'PUT',
            body: JSON.stringify({ name: name, hostId: myPeerId })
        });

        showRoom(name, true);
    }

    // 2. –í—Ö–æ–¥ –≤ —á—É–∂—É—é –∫–æ–º–Ω–∞—Ç—É (–ó—Ä–∏—Ç–µ–ª—å)
    function joinRoom(hostId, name) {
        showRoom(name, false);
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ç—Ä–∏–º–µ—Ä—É
        const call = peer.call(hostId, null); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –≤—ã–∑–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Ç–æ–∫
        call.on('stream', (remoteStream) => {
            document.getElementById('remote-video').srcObject = remoteStream;
        });
    }

    // 3. –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞
    async function shareScreen() {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        document.getElementById('remote-video').srcObject = stream;
        
        // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –æ—Ç –∑—Ä–∏—Ç–µ–ª–µ–π —Å–≤–æ–∏–º –ø–æ—Ç–æ–∫–æ–º
        peer.on('call', (call) => {
            call.answer(stream);
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function showRoom(title, isHost) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('room').style.display = 'flex';
        document.getElementById('room-title').innerText = "–≠–§–ò–†: " + title;
        if (isHost) document.getElementById('host-controls').style.display = 'flex';
    }

    async function loadRooms() {
        const res = await fetch(DB_URL);
        const data = await res.json();
        const list = document.getElementById('room-list');
        if (!data) return;
        list.innerHTML = "";
        
        for (let id in data) {
            const r = data[id];
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<h3>${r.name}</h3><p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏</p>`;
            card.onclick = () => joinRoom(r.hostId, r.name);
            list.appendChild(card);
        }
    }

    setInterval(loadRooms, 5000); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
</script>

</body>
</html>
