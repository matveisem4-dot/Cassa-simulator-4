<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Платежный Терминал</title>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #main-container { text-align: center; }
        
        /* Экраны */
        #wait-screen, #payment-screen, #success-screen { display: none; }
        #wait-screen { display: block; } /* Показываем только этот экран в начале */

        /* Стиль QR-кода */
        .qr-wrapper { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            display: inline-block; 
            margin-top: 20px;
        }
        .qr-wrapper img { 
            display: block; 
            width: 250px; 
            height: 250px; 
        }

        .price { font-size: 40px; color: #00ff41; margin-bottom: 10px; font-weight: bold; }
        .terminal-id { position: absolute; bottom: 20px; left: 20px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 5px; font-size: 14px; color: #888; }
        
        h2 { font-size: 28px; margin-bottom: 10px; }
        p { color: #ccc; }
    </style>
</head>
<body>

    <div id="main-container">
        <!-- ЭКРАН 1: ОЖИДАНИЕ -->
        <div id="wait-screen">
            <h2>СВОБОДНАЯ КАССА</h2>
            <p>Ожидание команды от кассового аппарата...</p>
        </div>

        <!-- ЭКРАН 2: ОПЛАТА (ЗДЕСЬ QR) -->
        <div id="payment-screen">
            <div id="price-tag" class="price">0.00 руб</div>
            <div class="qr-wrapper">
                <!-- Мы используем надежный сервис генерации QR -->
                <img id="qr-image" src="" alt="QR Оплата">
            </div>
            <p style="margin-top:20px;">Отсканируйте и введите ID: <strong id="display-id" style="color:white; font-size:20px;"></strong></p>
        </div>

        <!-- ЭКРАН 3: УСПЕХ -->
        <div id="success-screen">
            <h1 style="color: #00ff41; font-size: 50px;">✅ ОПЛАЧЕНО</h1>
            <p>Спасибо за покупку!</p>
        </div>
    </div>

    <!-- ID В УГЛУ -->
    <div class="terminal-id">ID ТЕРМИНАЛА: <span id="my-id">Генерация...</span></div>

    <script>
        const FIREBASE_URL = "https://cassa-simulator-4-default-rtdb.firebaseio.com";
        const PAYMENT_SITE_URL = "your-site.com"; // ЗАМЕНИ НА СВОЙ САЙТ
        
        let terminalId = Math.floor(100000 + Math.random() * 900000);
        document.getElementById('my-id').innerText = terminalId;
        document.getElementById('display-id').innerText = terminalId;

        // Функция показа QR
        function updateQRCode() {
            const qrImg = document.getElementById('qr-image');
            // Используем Google Charts API - это самый надежный способ в мире
            const qrUrl = `chart.googleapis.com{encodeURIComponent(PAYMENT_SITE_URL)}`;
            qrImg.src = qrUrl;
        }

        async function checkCommands() {
            try {
                // 1. Проверяем наличие команды PAY
                const cmdRes = await fetch(`${FIREBASE_URL}/commands/${terminalId}.json`);
                const cmdData = await cmdRes.json();

                if (cmdData && cmdData.command === "PAY") {
                    document.getElementById('price-tag').innerText = cmdData.amount + " руб";
                    updateQRCode(); // Генерируем картинку
                    showScreen('payment-screen');
                }

                // 2. Проверяем статус SUCCESS
                const statusRes = await fetch(`${FIREBASE_URL}/status/${terminalId}.json`);
                const statusData = await statusRes.json();

                if (statusData === "SUCCESS") {
                    showScreen('success-screen');
                    // Очищаем данные через 5 секунд и возвращаемся в ожидание
                    setTimeout(resetTerminal, 5000);
                }
            } catch (e) {
                console.log("Ошибка связи с Firebase");
            }
        }

        function showScreen(screenId) {
            document.getElementById('wait-screen').style.display = 'none';
            document.getElementById('payment-screen').style.display = 'none';
            document.getElementById('success-screen').style.display = 'none';
            document.getElementById(screenId).style.display = 'block';
        }

        async function resetTerminal() {
            await fetch(`${FIREBASE_URL}/commands/${terminalId}.json`, { method: 'DELETE' });
            await fetch(`${FIREBASE_URL}/status/${terminalId}.json`, { method: 'DELETE' });
            showScreen('wait-screen');
        }

        // Проверяем обновления каждые 2 секунды
        setInterval(checkCommands, 2000);
    </script>
</body>
</html>
