<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SberPay Terminal</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @font-face { font-family: 'SberDisplay'; src: local('Arial Bold'); font-weight: 700; }
        body { margin: 0; font-family: 'SberDisplay', sans-serif; background: #1a1a1a; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #phone-container { width: 360px; height: 740px; background: linear-gradient(to bottom, #004d25, #00a040); border-radius: 40px; border: 8px solid #333; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; text-align: center; padding-top: 50px; }
        .active { display: flex; flex-direction: column; align-items: center; }
        .price { font-size: 42px; color: #00ff41; margin: 20px 0; }
        .qr-box { background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        input { width: 80%; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; font-size: 16px; text-align: center; }
        button { background: #00ff41; color: #000; border: none; padding: 15px; border-radius: 15px; font-weight: bold; width: 85%; cursor: pointer; margin: 5px 0; }
        #video-feed { width: 240px; height: 240px; border-radius: 50%; border: 4px solid #00ff41; object-fit: cover; background: #000; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="phone-container">
    <div id="scr-start" class="screen active">
        <h1>SberPay</h1>
        <button onclick="openPay(750)">Оплатить 750 РУБ</button>
    </div>

    <div id="scr-pay" class="screen">
        <div class="price" id="amt">0 РУБ</div>
        <div class="qr-box" id="qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SberPaySim" width="150"></div>
        <input type="text" id="card-num" placeholder="Номер карты (4400...)">
        <input type="password" id="card-pin" placeholder="ПИН" maxlength="4">
        <button onclick="payCard()">ОПЛАТИТЬ КАРТОЙ</button>
        <button style="background:#eee" onclick="paySmile()">ОПЛАТИТЬ УЛЫБКОЙ</button>
    </div>

    <div id="scr-smile" class="screen">
        <video id="video-feed" autoplay playsinline></video>
        <h2>Улыбнитесь...</h2>
    </div>

    <div id="scr-ok" class="screen">
        <div style="font-size: 80px; margin-top: 100px;">✅</div>
        <h1 style="color: #00ff41;">УСПЕШНО</h1>
        <button onclick="location.reload()">В НАЧАЛО</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://cassa-simulator-4-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentAmt = 0;

    function openPay(a) { currentAmt = a; document.getElementById('amt').innerText = a + " РУБ"; switchScr('scr-pay'); }
    function switchScr(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    async function payCard() {
        const num = document.getElementById('card-num').value.trim();
        const pin = document.getElementById('card-pin').value.trim();
        const snap = await db.ref('cards/' + num).once('value');
        const data = snap.val();

        if (data && data.pin == pin) {
            if (data.balance >= currentAmt) {
                await db.ref('cards/' + num).update({ balance: data.balance - currentAmt });
                switchScr('scr-ok');
            } else { alert("❌ Мало денег!"); }
        } else { alert("❌ Ошибка данных!"); }
    }

    async function paySmile() {
        switchScr('scr-smile');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('video-feed').srcObject = stream;
        setTimeout(() => {
            stream.getTracks().forEach(t => t.stop());
            switchScr('scr-ok');
        }, 3000);
    }
</script>
</body>
</html>
