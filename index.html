<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Система оплаты 2025</title>
    <script defer src="cdn.jsdelivr.net"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; }
        .payment-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin-top: 50px; width: 450px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-qr { background: #333; color: white; }
        .btn-smile { background: #00c853; color: white; }
        
        #camera-container { display: none; margin-top: 20px; position: relative; }
        video { width: 100%; border-radius: 15px; background: #000; }
        #timer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; color: white; font-weight: bold; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        #qr-container { display: none; margin-top: 20px; }
        .status { margin-top: 15px; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>

<div class="payment-card">
    <h2>Выберите способ оплаты</h2>
    
    <div class="btn-group">
        <button class="btn-qr" onclick="showQR()">Оплата по QR</button>
        <button class="btn-smile" onclick="startSmilePayment()">Оплата по улыбке</button>
    </div>

    <!-- Блок QR-кода -->
    <div id="qr-container">
        <p>Сканируйте код для оплаты:</p>
        <img src="api.qrserver.com" alt="QR Code">
    </div>

    <!-- Блок Камеры и Таймера -->
    <div id="camera-container">
        <video id="video" autoplay muted></video>
        <div id="timer"></div>
    </div>

    <div id="status" class="status"></div>
</div>

<script>
    const video = document.getElementById('video');
    const timerDiv = document.getElementById('timer');
    const statusDiv = document.getElementById('status');
    const cameraBox = document.getElementById('camera-container');
    const qrBox = document.getElementById('qr-container');

    // Загрузка моделей нейросети при старте
    async function init() {
        const MODEL_URL = 'raw.githubusercontent.com';
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    }
    init();

    function showQR() {
        cameraBox.style.display = 'none';
        qrBox.style.display = 'block';
        statusDiv.innerText = "";
    }

    async function startSmilePayment() {
        qrBox.style.display = 'none';
        cameraBox.style.display = 'block';
        statusDiv.innerText = "Приготовьтесь улыбаться!";
        statusDiv.style.color = "black";

        // Запуск камеры
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;

        // Таймер 3 секунды
        let timeLeft = 3;
        timerDiv.innerText = timeLeft;

        const countdown = setInterval(async () => {
            timeLeft--;
            if (timeLeft > 0) {
                timerDiv.innerText = timeLeft;
            } else {
                clearInterval(countdown);
                timerDiv.innerText = "";
                checkSmile(); // Проверка в момент окончания таймера
            }
        }, 1000);
    }

    async function checkSmile() {
        statusDiv.innerText = "Сканирую лицо...";
        
        // Делаем снимок эмоции
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

        if (detections.length > 0) {
            const happiness = detections[0].expressions.happy;
            console.log("Уровень счастья:", happiness);

            if (happiness > 0.7) {
                statusDiv.innerText = "✅ Успешно оплачено!";
                statusDiv.style.color = "green";
                // Здесь можно остановить камеру
                stopCamera();
            } else {
                statusDiv.innerText = "❌ Вы не улыбнулись. Повторите попытку!";
                statusDiv.style.color = "red";
            }
        } else {
            statusDiv.innerText = "❌ Лицо не обнаружено. Попробуйте еще раз.";
            statusDiv.style.color = "red";
        }
    }

    function stopCamera() {
        const stream = video.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
    }
</script>

</body>
</html>
