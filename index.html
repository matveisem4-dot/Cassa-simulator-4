<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SberPay Auto Terminal</title>
    <style>
        :root {
            --sber-green: #21a038;
            --bg-light: #f4f4f7; 
            --card-bg: #ffffff;
            --text-main: #121212;
            --text-secondary: #6e6e73;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #e5e5e7;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        #phone-screen-container {
            width: 100%; height: 100vh;
            max-width: 430px;
            background: var(--bg-light);
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 450px) {
            #phone-screen-container { height: 90vh; border-radius: 45px; border: 12px solid #ffffff; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        }

        .header { padding: 50px 30px 20px; display: flex; }
        .sber-logo { height: 26px; }

        .screen { display: none; flex-direction: column; flex: 1; padding: 0 30px 40px; }
        .screen.active { display: flex; animation: fadeIn 0.4s ease-out; }

        .main-text { font-size: 40px; font-weight: 700; line-height: 1.1; margin-top: 20px; color: var(--text-main); letter-spacing: -1.5px; }
        .smile-inline { height: 1em; vertical-align: middle; margin: 0 4px; }

        .payment-card {
            background: var(--card-bg);
            border-radius: 35px;
            padding: 30px 20px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
            margin-top: auto; margin-bottom: 20px;
        }

        .price-val { font-size: 48px; font-weight: 800; color: var(--text-main); margin-bottom: 5px; }
        .price-sub { font-size: 14px; color: var(--text-secondary); margin-bottom: 25px; }

        #qrcode-image { width: 180px; height: 180px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #f0f0f0; padding: 10px; }

        .btn-smile { background: var(--sber-green); color: #ffffff; border: none; width: 100%; padding: 20px; border-radius: 20px; font-size: 18px; font-weight: 700; cursor: pointer; }

        .terminal-info { text-align: center; padding-bottom: 20px; font-size: 11px; color: var(--text-secondary); font-weight: 600; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="phone-screen-container">
        <div class="header">
            <img class="sber-logo" src="upload.wikimedia.org" alt="SberPay">
        </div>

        <!-- ОЖИДАНИЕ (Синий экран будет висеть, пока нет команды) -->
        <div id="screen-wait" class="screen active">
            <div class="main-text">
                платите<br>
                <img src="www.sberbank.ru" class="smile-inline" alt="smile">
                как вам<br>
                удобно
            </div>
        </div>
        
        <!-- ОПЛАТА (Появится само по команде PAY) -->
        <div id="screen-pay" class="screen">
            <div class="payment-card">
                <div id="amount-val" class="price-val">0.00 ₽</div>
                <div class="price-sub">SberPay: QR или Улыбка</div>
                <img id="qrcode-image" src="" alt="QR">
                <button class="btn-smile" onclick="confirmPayment()">Оплатить улыбкой</button>
            </div>
        </div>

        <!-- УСПЕХ -->
        <div id="screen-success" class="screen" style="justify-content: center; align-items: center;">
            <div style="background: #e8f5e9; width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <span style="font-size: 40px;">✅</span>
            </div>
            <h1 style="font-size: 28px; margin: 0;">Оплачено</h1>
            <p style="color: var(--text-secondary);">Терминал готов к работе</p>
        </div>

        <div class="terminal-info">ID: <span id="display-id">00544048</span></div>
    </div>
    
    <script>
        // ИСПОЛЬЗУЙТЕ СВОЙ ID (такой же как в приложении)
        const MY_TERMINAL_ID = "00544048"; 
        const FB_URL = "https://cassa-simulator-4-default-rtdb.firebaseio.com";
        let currentScreen = 'wait';

        document.getElementById('display-id').innerText = MY_TERMINAL_ID;

        // 1. Постоянная проверка Firebase
        async function syncWithFirebase() {
            try {
                // Проверяем папку commands
                const response = await fetch(`${FB_URL}/commands/${MY_TERMINAL_ID}.json`);
                const data = await response.json();

                if (data && data.command === "PAY" && currentScreen === 'wait') {
                    // Если пришла команда PAY и мы еще в режиме ожидания — запускаем оплату
                    startPaymentProcess(data.amount);
                }

                // Проверяем статус (если оплата прошла успешно в базе)
                const statusRes = await fetch(`${FB_URL}/status/${MY_TERMINAL_ID}.json`);
                const statusData = await statusRes.json();
                if (statusData?.state === "SUCCESS" && currentScreen === 'pay') {
                    showSuccess();
                }
            } catch (e) { console.error("Firebase Sync Error", e); }
        }

        // 2. Логика отображения оплаты
        function startPaymentProcess(amount) {
            document.getElementById('amount-val').innerText = amount + " ₽";
            document.getElementById('qrcode-image').src = `chart.googleapis.com{MY_TERMINAL_ID}_${amount}&choe=UTF-8`;
            
            showScreen('pay');
            updateStatus("WAITING_PAYMENT");
        }

        // 3. Подтверждение оплаты (кнопка Улыбка)
        async function confirmPayment() {
            await updateStatus("SUCCESS");
            showSuccess();
        }

        function showSuccess() {
            showScreen('success');
            setTimeout(resetTerminal, 5000); // Через 5 секунд возвращаемся в ожидание
        }

        async function resetTerminal() {
            await updateStatus("IDLE");
            // Удаляем команду из Firebase, чтобы она не сработала второй раз
            await fetch(`${FB_URL}/commands/${MY_TERMINAL_ID}.json`, { method: 'DELETE' });
            showScreen('wait');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            currentScreen = id;
        }

        async function updateStatus(state) {
            try {
                await fetch(`${FB_URL}/status/${MY_TERMINAL_ID}.json`, {
                    method: 'PUT',
                    body: JSON.stringify({ state, lastUpdate: Date.now() })
                });
            } catch (e) {}
        }

        // Запускаем цикл опроса раз в 2 секунды
        setInterval(syncWithFirebase, 2000);
        
        // Сбрасываем статус при загрузке
        updateStatus("IDLE");
    </script>
</body>
</html>
