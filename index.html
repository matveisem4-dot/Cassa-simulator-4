<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SberPay Terminal</title>
    <style>
        @font-face { font-family: 'SberDisplay'; src: local('Arial Bold'), sans-serif; font-weight: 700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'SberDisplay', sans-serif; background: #004d25; overflow: hidden; color: #ffffff !important; }
        #main-container { width: 100vw; height: 100vh; background: linear-gradient(to bottom, #004d25, #00a040); position: relative; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; height: 100%; text-align: center; padding-top: 10%; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: flex; flex-direction: column; align-items: center; opacity: 1; }
        .text-container { width: 100%; text-align: left; padding: 0 10%; margin-top: 10px; }
        .main-text { font-size: 9vw; font-weight: bold; line-height: 1.1; display: flex; align-items: center; gap: 10px; animation: slideInFromLeft 0.8s forwards; }
        .price-text { font-size: 11vw; color: #00ff41 !important; font-weight: 800; margin: 10px 0; }
        #qrcode-container { background: #fff; padding: 10px; border-radius: 15px; margin: 10px; width: 55vw; height: 55vw; max-width: 220px; max-height: 220px; }
        #qrcode-image { width: 100%; height: 100%; }
        button { background: #00ff41; color: #000; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 90%; margin-top: 10px; cursor: pointer; }
        .terminal-id-badge { position: absolute; bottom: 13px; left: 15px; font-size: 10px; opacity: 0.6; }
        #smile-modal { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: #000; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #v { width: 280px; height: 280px; object-fit: cover; border-radius: 50%; border: 4px solid #00ff41; }
        @keyframes slideInFromLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="screen-wait" class="screen active">
            <div class="text-container">
                <div class="main-text">ПЛАТИТЕ КАК ВАМ УДОБНО</div>
            </div>
        </div>

        <div id="screen-pay" class="screen">
            <div id="amount-val" class="price-text">0.00 ₽</div>
            <div id="qrcode-container">
                 <img id="qrcode-image" src="my_qr_code.svg">
            </div>
            <button onclick="initiateSmilePayment()">ОПЛАТА УЛЫБКОЙ</button>
        </div>

        <div id="screen-success" class="screen">
            <div style="font-size: 80px; margin-top: 80px;">✅</div>
            <h1 style="color: #00ff41 !important;">ОПЛАЧЕНО</h1>
        </div>

        <div class="terminal-id-badge">ID: <span id="terminal-id-display">...</span></div>
        <div id="smile-modal"><video id="v" autoplay playsinline></video><h2>УЛЫБНИТЕСЬ</h2></div>
    </div>

    <script>
        const DB = "https://cassa-simulator-4-default-rtdb.firebaseio.com";
        let MY_ID = localStorage.getItem('terminal_id') || Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('terminal_id', MY_ID);
        document.getElementById('terminal-id-display').innerText = MY_ID;

        let currentScreen = 'wait';
        
        async function sync() {
            try {
                if (currentScreen === 'wait') {
                    const res = await fetch(`${DB}/commands/${MY_ID}.json`);
                    const data = await res.json();
                    if (data && data.command === "PAY") {
                        document.getElementById('amount-val').innerText = data.amount + " ₽";
                        showScreen('screen-pay');
                    }
                }
                if (currentScreen === 'pay') {
                    const res = await fetch(`${DB}/status/${MY_ID}.json`);
                    const data = await res.json();
                    if (data && data.state === "SUCCESS") {
                        showScreen('screen-success');
                        setTimeout(async () => {
                            await fetch(`${DB}/commands/${MY_ID}.json`, { method: 'DELETE' });
                            await fetch(`${DB}/status/${MY_ID}.json`, { method: 'PUT', body: JSON.stringify({state:"IDLE"}) });
                            location.reload();
                        }, 4000);
                    }
                }
            } catch (e) {}
        }

        async function initiateSmilePayment() {
            document.getElementById('smile-modal').style.display = 'flex';
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('v').srcObject = stream;
            setTimeout(async () => {
                stream.getTracks().forEach(t => t.stop());
                await fetch(`${DB}/status/${MY_ID}.json`, { method: 'PUT', body: JSON.stringify({ state: "SUCCESS", method: "SMILE" }) });
            }, 3000);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            currentScreen = id.replace('screen-', '');
        }

        setInterval(sync, 2000);
    </script>
</body>
</html>
