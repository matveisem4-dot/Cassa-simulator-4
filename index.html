<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SberPay Terminal 2026 Full</title>
    <style>
        @font-face { font-family: 'SberDisplay'; src: local('Arial Bold'), sans-serif; font-weight: 700; }
        body { margin: 0; font-family: 'SberDisplay', sans-serif; background: #1a1a1a; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        #phone-screen-container {
            width: 380px; height: 780px;
            background: linear-gradient(to bottom, #004d25, #00a040);
            position: relative; border-radius: 25px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .screen { display: none; width: 100%; height: 100%; text-align: center; padding-top: 60px; box-sizing: border-box; }
        .screen.active { display: flex; flex-direction: column; align-items: center; }

        .price-text { font-size: 48px; color: #00ff41; font-weight: 800; margin: 20px 0; }
        
        #qrcode-container { background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        canvas { width: 220px !important; height: 220px !important; }

        .terminal-id-badge { position: absolute; bottom: 20px; left: 20px; font-size: 12px; color: rgba(255,255,255,0.6); }
        
        button { 
            background: #00ff41; color: #000; border: none; padding: 18px; 
            border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 18px; width: 85%; transition: 0.3s;
        }
        button:active { transform: scale(0.95); }

        /* Окно камеры */
        #smile-modal { 
            display: none; position: absolute; top:0; left:0; width:100%; height:100%; 
            background: #000; flex-direction: column; align-items: center; justify-content: center; z-index: 100; 
        }
        #webcam { width: 100%; height: 60%; object-fit: cover; border-bottom: 4px solid #00ff41; transform: scaleX(-1); }

        #status-indicator { position: absolute; bottom: 22px; right: 20px; width: 12px; height: 12px; border-radius: 50%; background: gray; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
    <!-- Подключаем библиотеку для QR, чтобы он точно "спавнился" -->
    <script src="cdnjs.cloudflare.com"></script>
</head>
<body>

    <div id="phone-screen-container">
        <!-- ЭКРАН 1: ПРИВЕТСТВИЕ -->
        <div id="screen-wait" class="screen active">
            <h1 style="margin-top:100px;">SberPay</h1>
            <p>Готов к работе</p>
            <button onclick="startPaymentProcess()" style="margin-top:auto; margin-bottom: 50px;">Начать оплату</button>
        </div>

        <!-- ЭКРАН 2: ОПЛАТА -->
        <div id="screen-pay" class="screen">
            <div id="amount-display" class="price-text">0.00 ₽</div>
            <div id="qrcode-container">
                <canvas id="qr"></canvas>
            </div>
            <p style="margin-bottom:5px;">ID ТЕРМИНАЛА</p>
            <h2 id="id-center" style="margin-top:0; color:#00ff41;">------</h2>
            <button onclick="openSmileCamera()">Оплатить улыбкой</button>
        </div>

        <!-- ЭКРАН 3: УСПЕХ -->
        <div id="screen-success" class="screen">
            <div style="font-size: 80px; margin-top: 150px;">✅</div>
            <h1 style="color:#00ff41;">ОПЛАЧЕНО</h1>
            <button onclick="resetTerminal()" style="margin-top: auto; margin-bottom: 50px;">В начало</button>
        </div>

        <!-- МОДАЛКА КАМЕРЫ -->
        <div id="smile-modal">
            <video id="webcam" autoplay playsinline></video>
            <h2 style="color:#00ff41;">Улыбнитесь!</h2>
            <p id="scan-text">Сканирование лица...</p>
        </div>

        <div class="terminal-id-badge">ID: <span id="id-bottom">...</span></div>
        <div id="status-indicator"></div>
    </div>

    <script>
        const DB_URL = "https://cassa-simulator-4-default-rtdb.firebaseio.com";
        let terminalId = localStorage.getItem('term_id') || Math.floor(100000 + Math.random() * 900000);
        localStorage.setItem('term_id', terminalId);

        // Сразу выводим ID во все поля
        document.getElementById('id-bottom').innerText = terminalId;
        document.getElementById('id-center').innerText = terminalId;

        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
        }

        async function startPaymentProcess() {
            const sum = (Math.random() * 1000 + 50).toFixed(2);
            document.getElementById('amount-display').innerText = sum + " ₽";
            
            // Генерация QR
            new QRious({ element: document.getElementById('qr'), value: "sberbank.ru" + terminalId, size: 250 });

            showScreen('pay');
            updateDB("WAITING", sum);
        }

        async function updateDB(status, amount = 0) {
            try {
                await fetch(`${DB_URL}/terminals/${terminalId}.json`, {
                    method: 'PUT',
                    body: JSON.stringify({ status, amount, time: Date.now() })
                });
                document.getElementById('status-indicator').style.background = '#00ff41';
            } catch(e) { 
                document.getElementById('status-indicator').style.background = 'red';
            }
        }

        async function openSmileCamera() {
            const modal = document.getElementById('smile-modal');
            const video = document.getElementById('webcam');
            modal.style.display = 'flex';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                
                setTimeout(() => {
                    document.getElementById('scan-text').innerText = "ЛИЦО РАСПОЗНАНО!";
                    setTimeout(() => {
                        stream.getTracks().forEach(t => t.stop());
                        modal.style.display = 'none';
                        showScreen('success');
                        updateDB("SUCCESS");
                    }, 1500);
                }, 3000);
            } catch(e) {
                alert("Ошибка камеры: " + e.message);
                modal.style.display = 'none';
            }
        }

        function resetTerminal() {
            updateDB("IDLE");
            showScreen('wait');
        }

        // Проверка команд извне (раз в 3 сек)
        setInterval(async () => {
            try {
                const res = await fetch(`${DB_URL}/terminals/${terminalId}.json`);
                const data = await res.json();
                if (data && data.status === "REMOTE_PAY") showScreen('success');
            } catch(e) {}
        }, 3000);

    </script>
</body>
</html>
